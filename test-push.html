<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°æ¨é€æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-900 text-white p-6">
    <div class="max-w-md mx-auto">
        <h1 class="text-2xl font-bold mb-6">PWA åå°æ¨é€æµ‹è¯•</h1>
        
        <div class="space-y-4">
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="font-semibold mb-2">Service Worker çŠ¶æ€</h3>
                <div id="swStatus" class="text-gray-400">æ£€æŸ¥ä¸­...</div>
            </div>
            
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="font-semibold mb-2">é€šçŸ¥æƒé™</h3>
                <div id="notificationStatus" class="text-gray-400">æ£€æŸ¥ä¸­...</div>
                <button id="requestPermission" class="mt-2 bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">
                    è¯·æ±‚æƒé™
                </button>
            </div>
            
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="font-semibold mb-2">æµ‹è¯•åŠŸèƒ½</h3>
                <div class="space-y-2">
                    <button id="testNotification" class="w-full bg-green-600 px-4 py-2 rounded hover:bg-green-700">
                        æµ‹è¯•ç«‹å³é€šçŸ¥
                    </button>
                    <button id="startReminder" class="w-full bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">
                        å¯åŠ¨1åˆ†é’Ÿæé†’æµ‹è¯•
                    </button>
                    <button id="stopReminder" class="w-full bg-red-600 px-4 py-2 rounded hover:bg-red-700">
                        åœæ­¢æé†’
                    </button>
                </div>
            </div>
            
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="font-semibold mb-2">æ—¥å¿—</h3>
                <div id="log" class="text-sm text-gray-400 max-h-40 overflow-y-auto"></div>
            </div>
        </div>
    </div>
    
    <script>
        let registration = null;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        async function checkServiceWorker() {
            const statusDiv = document.getElementById('swStatus');
            
            if ('serviceWorker' in navigator) {
                try {
                    registration = await navigator.serviceWorker.register('sw.js');
                    statusDiv.innerHTML = `
                        <div class="text-green-400">âœ… å·²æ³¨å†Œ</div>
                        <div class="text-xs">çŠ¶æ€: ${registration.active ? 'æ¿€æ´»' : 'ç­‰å¾…æ¿€æ´»'}</div>
                    `;
                    log('Service Worker æ³¨å†ŒæˆåŠŸ');
                    
                    // ç­‰å¾…æ¿€æ´»
                    if (registration.installing) {
                        await new Promise(resolve => {
                            registration.installing.addEventListener('statechange', () => {
                                if (registration.installing.state === 'activated') {
                                    resolve();
                                }
                            });
                        });
                    }
                    
                } catch (error) {
                    statusDiv.innerHTML = `<div class="text-red-400">âŒ æ³¨å†Œå¤±è´¥: ${error.message}</div>`;
                    log('Service Worker æ³¨å†Œå¤±è´¥: ' + error.message);
                }
            } else {
                statusDiv.innerHTML = '<div class="text-red-400">âŒ ä¸æ”¯æŒ Service Worker</div>';
                log('æµè§ˆå™¨ä¸æ”¯æŒ Service Worker');
            }
        }
        
        function checkNotificationPermission() {
            const statusDiv = document.getElementById('notificationStatus');
            
            if ('Notification' in window) {
                const permission = Notification.permission;
                let statusText = '';
                let statusColor = '';
                
                switch (permission) {
                    case 'granted':
                        statusText = 'âœ… å·²æˆæƒ';
                        statusColor = 'text-green-400';
                        break;
                    case 'denied':
                        statusText = 'âŒ å·²æ‹’ç»';
                        statusColor = 'text-red-400';
                        break;
                    case 'default':
                        statusText = 'â³ æœªè®¾ç½®';
                        statusColor = 'text-yellow-400';
                        break;
                }
                
                statusDiv.innerHTML = `<div class="${statusColor}">${statusText}</div>`;
                log('é€šçŸ¥æƒé™çŠ¶æ€: ' + permission);
            } else {
                statusDiv.innerHTML = '<div class="text-red-400">âŒ ä¸æ”¯æŒé€šçŸ¥</div>';
                log('æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥');
            }
        }
        
        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                log('é€šçŸ¥æƒé™è¯·æ±‚ç»“æœ: ' + permission);
                checkNotificationPermission();
            }
        }
        
        function testNotification() {
            if (Notification.permission === 'granted') {
                new Notification('æµ‹è¯•é€šçŸ¥', {
                    body: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é€šçŸ¥ ğŸ’§',
                    icon: '/icons/icon-192x192.png',
                    tag: 'test'
                });
                log('å‘é€æµ‹è¯•é€šçŸ¥');
            } else {
                log('é€šçŸ¥æƒé™æœªæˆæƒ');
            }
        }
        
        function startReminderTest() {
            if (registration && registration.active) {
                registration.active.postMessage({
                    type: 'UPDATE_REMINDER_SETTINGS',
                    data: {
                        isActive: true,
                        interval: 1, // 1åˆ†é’Ÿæµ‹è¯•
                        lastReminder: 0 // ç«‹å³è§¦å‘
                    }
                });
                log('å¯åŠ¨1åˆ†é’Ÿæé†’æµ‹è¯•');
            } else {
                log('Service Worker æœªå°±ç»ª');
            }
        }
        
        function stopReminderTest() {
            if (registration && registration.active) {
                registration.active.postMessage({
                    type: 'UPDATE_REMINDER_SETTINGS',
                    data: {
                        isActive: false
                    }
                });
                log('åœæ­¢æé†’æµ‹è¯•');
            } else {
                log('Service Worker æœªå°±ç»ª');
            }
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            await checkServiceWorker();
            checkNotificationPermission();
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('requestPermission').addEventListener('click', requestNotificationPermission);
            document.getElementById('testNotification').addEventListener('click', testNotification);
            document.getElementById('startReminder').addEventListener('click', startReminderTest);
            document.getElementById('stopReminder').addEventListener('click', stopReminderTest);
            
            log('æµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html>
